<!DOCTYPE html>
<html>
<head>
  <title>Advanced Driver Location Recorder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(45deg, #ff6b6b, #ffa500);
      color: white;
      padding: 30px 20px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 24px;
      margin-bottom: 10px;
    }
    
    .status-indicator {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      background: rgba(255,255,255,0.2);
    }
    
    .content {
      padding: 30px 20px;
    }
    
    .timer-section {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .timer-display {
      font-size: 48px;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
      font-family: 'Courier New', monospace;
    }
    
    .timer-label {
      color: #666;
      font-size: 14px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      border-left: 4px solid #007bff;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #007bff;
      margin-bottom: 5px;
    }
    
    .stat-label {
      color: #666;
      font-size: 12px;
    }
    
    .controls {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
    }
    
    .btn {
      flex: 1;
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-start {
      background: #28a745;
      color: white;
    }
    
    .btn-start:hover {
      background: #218838;
      transform: translateY(-2px);
    }
    
    .btn-stop {
      background: #dc3545;
      color: white;
    }
    
    .btn-stop:hover {
      background: #c82333;
      transform: translateY(-2px);
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .signal-status {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .signal-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .signal-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    .signal-good { background: #28a745; }
    .signal-weak { background: #ffc107; }
    .signal-lost { background: #dc3545; }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    .coordinates-preview {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 15px;
      max-height: 150px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
    
    .coordinate-entry {
      margin-bottom: 5px;
      color: #666;
    }
    
    .auto-sync-status {
      background: #e7f3ff;
      border: 1px solid #b3d9ff;
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
    }
    
    .sync-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .loading-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üöç Driver Location Recorder</h1>
      <div class="status-indicator" id="recordingStatus">
        ‚≠ï Ready to Start
      </div>
    </div>
    
    <div class="content">
      <!-- Timer Section -->
      <div class="timer-section">
        <div class="timer-display" id="timerDisplay">00:00:00</div>
        <div class="timer-label">Recording Time</div>
      </div>
      
      <!-- Stats Grid -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="coordinateCount">0</div>
          <div class="stat-label">COORDINATES</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="autoSyncCount">0</div>
          <div class="stat-label">AUTO SYNCS</div>
        </div>
      </div>
      
      <!-- Signal Status -->
      <div class="signal-status">
        <div class="signal-indicator">
          <div class="signal-dot signal-good" id="signalDot"></div>
          <span id="signalText">GPS Signal: Searching...</span>
        </div>
        <div style="font-size: 12px; color: #666;" id="signalDetails">
          Accuracy: -- | Last Update: --
        </div>
      </div>
      
      <!-- Controls -->
      <div class="controls">
        <button class="btn btn-start" id="startBtn">
          ‚ñ∂Ô∏è Start Recording
        </button>
        <button class="btn btn-stop" id="stopBtn" disabled>
          ‚èπÔ∏è Stop & Send
        </button>
      </div>
      
      <!-- Auto Sync Status -->
      <div class="auto-sync-status" id="autoSyncStatus" style="display: none;">
        <div class="sync-indicator">
          <div class="loading-spinner"></div>
          <span>Auto-syncing coordinates...</span>
        </div>
      </div>
      
      <!-- Coordinates Preview -->
      <div style="margin-top: 20px;">
        <h4 style="margin-bottom: 10px; color: #333;">üìç Latest Coordinates</h4>
        <div class="coordinates-preview" id="coordinatesPreview">
          No coordinates recorded yet...
        </div>
      </div>
    </div>
  </div>

  <script>
    let coordinates = [];
    let watchId = null;
    let startTime = null;
    let timerInterval = null;
    let autoSyncCount = 0;
    let lastSuccessfulSync = null;
    let signalLostTimeout = null;
    let isRecording = false;

    // DOM Elements
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const timerDisplay = document.getElementById('timerDisplay');
    const recordingStatus = document.getElementById('recordingStatus');
    const coordinateCount = document.getElementById('coordinateCount');
    const autoSyncCountDisplay = document.getElementById('autoSyncCount');
    const signalDot = document.getElementById('signalDot');
    const signalText = document.getElementById('signalText');
    const signalDetails = document.getElementById('signalDetails');
    const coordinatesPreview = document.getElementById('coordinatesPreview');
    const autoSyncStatus = document.getElementById('autoSyncStatus');

    // API Configuration
    const API_ENDPOINTS = {
      primary: 'http://localhost:5001/api/buses/make-route',
      backup: 'https://your-backup-api.com/api/routes',
      emergency: 'https://emergency-backup.com/api/save'
    };

    // Timer Functions
    function startTimer() {
      startTime = Date.now();
      timerInterval = setInterval(updateTimer, 1000);
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function updateTimer() {
      if (startTime) {
        const elapsed = Date.now() - startTime;
        const hours = Math.floor(elapsed / 3600000);
        const minutes = Math.floor((elapsed % 3600000) / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);
        
        timerDisplay.textContent = 
          `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }
    }

    // Signal Status Functions
    function updateSignalStatus(accuracy, isGood = true) {
      if (isGood) {
        signalDot.className = 'signal-dot signal-good';
        signalText.textContent = 'GPS Signal: Strong';
      } else {
        signalDot.className = 'signal-dot signal-weak';
        signalText.textContent = 'GPS Signal: Weak';
      }
      
      signalDetails.textContent = 
        `Accuracy: ${accuracy}m | Last Update: ${new Date().toLocaleTimeString()}`;
    }

    function handleSignalLost() {
      signalDot.className = 'signal-dot signal-lost';
      signalText.textContent = 'GPS Signal: Lost';
      signalDetails.textContent = 'Connection lost - attempting auto-sync...';
      
      // Trigger auto-sync when signal is lost
      if (coordinates.length > 0) {
        autoSyncData('Signal lost - emergency sync');
      }
    }

    // Auto-sync Functions
    async function autoSyncData(reason = 'Periodic sync') {
      if (coordinates.length === 0) return;

      autoSyncStatus.style.display = 'block';
      
      try {
        // Try primary endpoint first
        await sendToAPI(API_ENDPOINTS.primary, coordinates, reason);
        autoSyncCount++;
        autoSyncCountDisplay.textContent = autoSyncCount;
        lastSuccessfulSync = new Date();
        
        // Clear coordinates after successful sync
        coordinates = [];
        updateCoordinatesDisplay();
        
        setTimeout(() => {
          autoSyncStatus.style.display = 'none';
        }, 2000);
        
      } catch (error) {
        console.error('Auto-sync failed:', error);
        // Try backup endpoints
        await tryBackupSync(reason);
      }
    }

    async function tryBackupSync(reason) {
      const endpoints = [API_ENDPOINTS.backup, API_ENDPOINTS.emergency];
      
      for (const endpoint of endpoints) {
        try {
          await sendToAPI(endpoint, coordinates, reason + ' - backup');
          autoSyncCount++;
          autoSyncCountDisplay.textContent = autoSyncCount;
          coordinates = [];
          updateCoordinatesDisplay();
          autoSyncStatus.style.display = 'none';
          return;
        } catch (error) {
          console.error(`Backup sync failed for ${endpoint}:`, error);
        }
      }
      
      // If all endpoints fail, keep data in memory
      autoSyncStatus.innerHTML = `
        <div class="sync-indicator">
          <span style="color: #dc3545;">‚ö†Ô∏è Auto-sync failed - data saved locally</span>
        </div>
      `;
    }

    async function sendToAPI(endpoint, data, reason) {
      const payload = {
        routeCoordinates: data,
        timestamp: new Date().toISOString(),
        reason: reason,
        deviceInfo: {
          userAgent: navigator.userAgent,
          timestamp: Date.now()
        }
      };

      const response = await fetch(endpoint, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'X-Source': 'driver-recorder'
        },
        body: JSON.stringify(payload),
        timeout: 10000
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      return response.text();
    }

    // Coordinates Display
    function updateCoordinatesDisplay() {
      coordinateCount.textContent = coordinates.length;
      
      if (coordinates.length === 0) {
        coordinatesPreview.innerHTML = 'No coordinates recorded yet...';
        return;
      }

      const recent = coordinates.slice(-5).reverse();
      coordinatesPreview.innerHTML = recent.map((coord, index) => 
        `<div class="coordinate-entry">
          ${coordinates.length - index}: [${coord.lat.toFixed(6)}, ${coord.lng.toFixed(6)}] 
          ${coord.time.split('T')[1].split('.')[0]}
        </div>`
      ).join('');
    }

    // Location Recording Functions
    function recordLocation() {
      if (!navigator.geolocation) {
        alert('Geolocation is not supported by your browser.');
        return;
      }

      const options = {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 5000
      };

      watchId = navigator.geolocation.watchPosition(
        (position) => {
          const { latitude, longitude, accuracy } = position.coords;
          const timestamp = new Date().toISOString();
          const coord = { lat: latitude, lng: longitude, time: timestamp, accuracy };
          
          coordinates.push(coord);
          updateCoordinatesDisplay();
          updateSignalStatus(accuracy, accuracy < 50);
          
          // Clear any existing signal lost timeout
          if (signalLostTimeout) {
            clearTimeout(signalLostTimeout);
          }
          
          // Auto-sync every 50 coordinates or every 5 minutes
          if (coordinates.length % 50 === 0 || 
              (lastSuccessfulSync && Date.now() - lastSuccessfulSync > 300000)) {
            autoSyncData('Periodic sync - 50 coordinates or 5 minutes');
          }
        },
        (error) => {
          console.warn('Location error:', error.message);
          
          // Set timeout to handle signal lost
          signalLostTimeout = setTimeout(() => {
            handleSignalLost();
          }, 10000); // 10 seconds timeout
        },
        options
      );
    }

    // Event Listeners
    startBtn.addEventListener('click', () => {
      if (!isRecording) {
        isRecording = true;
        recordingStatus.textContent = 'üî¥ Recording Active';
        recordingStatus.style.background = 'rgba(220, 53, 69, 0.8)';
        
        startBtn.disabled = true;
        stopBtn.disabled = false;
        
        startTimer();
        recordLocation();
        
        console.log('üöÄ Started location recording...');
      }
    });

    stopBtn.addEventListener('click', async () => {
      if (isRecording) {
        isRecording = false;
        recordingStatus.textContent = '‚≠ï Recording Stopped';
        recordingStatus.style.background = 'rgba(40, 167, 69, 0.8)';
        
        startBtn.disabled = false;
        stopBtn.disabled = true;
        
        stopTimer();
        
        if (watchId) {
          navigator.geolocation.clearWatch(watchId);
          watchId = null;
        }
        
        // Final sync
        if (coordinates.length > 0) {
          try {
            await autoSyncData('Final sync - recording stopped');
            alert(`‚úÖ Recording completed! ${coordinates.length} coordinates sent to server.`);
          } catch (error) {
            alert(`‚ö†Ô∏è Recording stopped but sync failed. ${coordinates.length} coordinates saved locally.`);
          }
        }
        
        console.log('‚èπÔ∏è Stopped recording and synced data');
      }
    });

    // Initialize
    updateCoordinatesDisplay();
    console.log('üéØ Advanced Driver Location Recorder initialized');
  </script>
</body>
</html>
